name: Smoke tests

on: 
  pull_request:
    paths:
      - '**.go'
      - go.mod
      - go.sum
      - Makefile
      - .github/workflows/smoke.yml
      - smoke-test/**

jobs:

  build:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        check-latest: true

    - name: Build
      run: make k0sctl

    - name: Stash the compiled binary for further testing
      uses: actions/upload-artifact@v4
      with:
        name: k0sctl
        path: k0sctl
        retention-days: 2

  smoke-four:
    name: Four controller+workers
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/smoke-test-cache
      - name: Run smoke test
        env:
          LINUX_IMAGE: quay.io/k0sproject/bootloose-alpine3.18
          BOOTLOOSE_TEMPLATE: bootloose.four.yaml
        run: make smoke-four

